{"version":3,"sources":["../../../../src/services/agentic-flow-hooks/todo-continuation-hooks.ts"],"sourcesContent":["/**\n * Todo Continuation Hook System for agentic-flow\n *\n * Enables automatic session continuation when incomplete tasks remain.\n * Injects system reminders to continue working on pending todos.\n */\n\nimport { agenticHookManager } from './hook-manager.js';\nimport type {\n  AgenticHookContext,\n  HookHandlerResult,\n  TodoContinuationHookPayload,\n  SideEffect,\n  TodoItem,\n  TodoState,\n} from './types.js';\n\n// ===== Todo Continuation Hook =====\n\nexport const todoContinuationHook = {\n  id: 'agentic-todo-continuation',\n  type: 'todo-continuation' as const,\n  priority: 95, // High priority to run early\n  handler: async (\n    payload: TodoContinuationHookPayload,\n    context: AgenticHookContext\n  ): Promise<HookHandlerResult> => {\n    const { todoState, proceedWithoutAsking, completionThreshold } = payload;\n\n    const sideEffects: SideEffect[] = [];\n\n    // If no todos or all complete, nothing to do\n    if (!todoState || todoState.total === 0 || todoState.remaining === 0) {\n      return { continue: true };\n    }\n\n    // Check if we're below the completion threshold\n    if (todoState.percentage >= completionThreshold) {\n      return { continue: true };\n    }\n\n    // Generate reminder message\n    const reminderMessage = generateReminderMessage(todoState, proceedWithoutAsking);\n\n    // Store continuation state\n    sideEffects.push({\n      type: 'memory',\n      action: 'store',\n      data: {\n        key: `todo:continuation:${context.sessionId}:${Date.now()}`,\n        value: {\n          todoState,\n          reminderMessage,\n          proceedWithoutAsking,\n          timestamp: Date.now(),\n        },\n        ttl: 86400, // 24 hours\n      },\n    });\n\n    // Log the continuation trigger\n    sideEffects.push({\n      type: 'log',\n      action: 'info',\n      data: {\n        message: `Todo continuation triggered: ${todoState.completed}/${todoState.total} completed`,\n        remaining: todoState.remaining,\n      },\n    });\n\n    // Emit notification for UI/system\n    sideEffects.push({\n      type: 'notification',\n      action: 'emit',\n      data: {\n        event: 'todo:continuation',\n        data: {\n          message: reminderMessage,\n          todoState,\n          proceedWithoutAsking,\n        },\n      },\n    });\n\n    return {\n      continue: true,\n      modified: true,\n      payload: {\n        ...payload,\n        reminderMessage,\n        shouldContinue: true,\n      },\n      metadata: {\n        todoStatus: `${todoState.completed}/${todoState.total} completed, ${todoState.remaining} remaining`,\n        incomplete: todoState.items.filter(i => i.status !== 'completed'),\n      },\n      sideEffects,\n    };\n  },\n};\n\n// ===== Todo Status Check Hook =====\n\nexport const todoStatusCheckHook = {\n  id: 'agentic-todo-status-check',\n  type: 'todo-status-check' as const,\n  priority: 100,\n  handler: async (\n    payload: TodoContinuationHookPayload,\n    context: AgenticHookContext\n  ): Promise<HookHandlerResult> => {\n    // Check current todo state from context\n    const todoState = context.todoState || payload.todoState;\n\n    if (!todoState) {\n      return { continue: true };\n    }\n\n    const sideEffects: SideEffect[] = [];\n\n    // Track status check\n    sideEffects.push({\n      type: 'metric',\n      action: 'update',\n      data: {\n        name: 'todo.status.check',\n        value: 1,\n        tags: {\n          completed: todoState.completed,\n          remaining: todoState.remaining,\n          percentage: todoState.percentage,\n        },\n      },\n    });\n\n    // Update context with current state\n    return {\n      continue: true,\n      modified: true,\n      metadata: {\n        todoState,\n        lastCheck: Date.now(),\n      },\n      sideEffects,\n    };\n  },\n};\n\n// ===== Todo Reminder Inject Hook =====\n\nexport const todoReminderInjectHook = {\n  id: 'agentic-todo-reminder-inject',\n  type: 'todo-reminder-inject' as const,\n  priority: 90,\n  handler: async (\n    payload: TodoContinuationHookPayload,\n    context: AgenticHookContext\n  ): Promise<HookHandlerResult> => {\n    const { todoState, proceedWithoutAsking } = payload;\n\n    if (!todoState || todoState.remaining === 0) {\n      return { continue: true };\n    }\n\n    const sideEffects: SideEffect[] = [];\n\n    // Generate the system reminder format (like the screenshot shows)\n    const systemReminder = formatSystemReminder(todoState, proceedWithoutAsking);\n\n    // Store reminder for injection\n    sideEffects.push({\n      type: 'memory',\n      action: 'store',\n      data: {\n        key: `todo:reminder:${context.sessionId}`,\n        value: {\n          reminder: systemReminder,\n          todoState,\n          generatedAt: Date.now(),\n        },\n        ttl: 3600, // 1 hour\n      },\n    });\n\n    // Log reminder injection\n    sideEffects.push({\n      type: 'log',\n      action: 'info',\n      data: {\n        message: 'System reminder injected for todo continuation',\n        completed: todoState.completed,\n        total: todoState.total,\n      },\n    });\n\n    return {\n      continue: true,\n      modified: true,\n      payload: {\n        ...payload,\n        reminderMessage: systemReminder,\n      },\n      metadata: {\n        systemReminder,\n        injectedAt: Date.now(),\n      },\n      sideEffects,\n    };\n  },\n};\n\n// ===== Helper Functions =====\n\n/**\n * Generate a reminder message for todo continuation\n */\nfunction generateReminderMessage(\n  todoState: TodoState,\n  proceedWithoutAsking: boolean\n): string {\n  const { completed, total, remaining, percentage } = todoState;\n\n  let message = `[SYSTEM REMINDER - TODO CONTINUATION]\\n\\n`;\n  message += `Incomplete tasks remain in your todo list. Continue working on the next pending task.\\n\\n`;\n\n  if (proceedWithoutAsking) {\n    message += `- Proceed without asking for permission\\n`;\n  }\n  message += `- Mark each task complete when finished\\n`;\n  message += `- Do not stop until all tasks are done\\n\\n`;\n\n  message += `[Status: ${completed}/${total} completed, ${remaining} remaining]`;\n\n  return message;\n}\n\n/**\n * Format a system reminder block (matches the UI format in the screenshot)\n */\nfunction formatSystemReminder(\n  todoState: TodoState,\n  proceedWithoutAsking: boolean\n): string {\n  const { completed, total, remaining } = todoState;\n\n  const lines: string[] = [\n    '[SYSTEM REMINDER - TODO CONTINUATION]',\n    '',\n    'Incomplete tasks remain in your todo list. Continue working on the next pending task.',\n    '',\n  ];\n\n  if (proceedWithoutAsking) {\n    lines.push('- Proceed without asking for permission');\n  }\n  lines.push('- Mark each task complete when finished');\n  lines.push('- Do not stop until all tasks are done');\n  lines.push('');\n  lines.push(`[Status: ${completed}/${total} completed, ${remaining} remaining]`);\n\n  return lines.join('\\n');\n}\n\n/**\n * Calculate todo state from a list of todo items\n */\nexport function calculateTodoState(todos: TodoItem[]): TodoState {\n  const total = todos.length;\n  const completed = todos.filter(t => t.status === 'completed').length;\n  const inProgress = todos.filter(t => t.status === 'in_progress').length;\n  const remaining = total - completed;\n  const percentage = total > 0 ? Math.round((completed / total) * 100) : 100;\n\n  return {\n    total,\n    completed,\n    remaining,\n    inProgress,\n    percentage,\n    items: todos,\n  };\n}\n\n/**\n * Check if continuation should trigger based on todo state\n */\nexport function shouldTriggerContinuation(\n  todoState: TodoState,\n  options: {\n    completionThreshold?: number;\n    minRemaining?: number;\n  } = {}\n): boolean {\n  const { completionThreshold = 100, minRemaining = 1 } = options;\n\n  // No todos = no continuation needed\n  if (todoState.total === 0) {\n    return false;\n  }\n\n  // All complete = no continuation needed\n  if (todoState.remaining === 0) {\n    return false;\n  }\n\n  // Below threshold and has minimum remaining\n  if (todoState.percentage < completionThreshold && todoState.remaining >= minRemaining) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Create a todo continuation payload for hook execution\n */\nexport function createTodoContinuationPayload(\n  todos: TodoItem[],\n  options: {\n    proceedWithoutAsking?: boolean;\n    completionThreshold?: number;\n  } = {}\n): TodoContinuationHookPayload {\n  const todoState = calculateTodoState(todos);\n  const { proceedWithoutAsking = true, completionThreshold = 100 } = options;\n\n  return {\n    operation: 'continue',\n    todoState,\n    proceedWithoutAsking,\n    completionThreshold,\n    shouldContinue: shouldTriggerContinuation(todoState, { completionThreshold }),\n  };\n}\n\n// ===== Register Hooks =====\n\nexport function registerTodoContinuationHooks(): void {\n  agenticHookManager.register(todoContinuationHook);\n  agenticHookManager.register(todoStatusCheckHook);\n  agenticHookManager.register(todoReminderInjectHook);\n}\n"],"names":["agenticHookManager","todoContinuationHook","id","type","priority","handler","payload","context","todoState","proceedWithoutAsking","completionThreshold","sideEffects","total","remaining","continue","percentage","reminderMessage","generateReminderMessage","push","action","data","key","sessionId","Date","now","value","timestamp","ttl","message","completed","event","modified","shouldContinue","metadata","todoStatus","incomplete","items","filter","i","status","todoStatusCheckHook","name","tags","lastCheck","todoReminderInjectHook","systemReminder","formatSystemReminder","reminder","generatedAt","injectedAt","lines","join","calculateTodoState","todos","length","t","inProgress","Math","round","shouldTriggerContinuation","options","minRemaining","createTodoContinuationPayload","operation","registerTodoContinuationHooks","register"],"mappings":"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"}