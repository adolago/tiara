{"version":3,"sources":["../../../src/utils/error-recovery.ts"],"sourcesContent":["/**\n * Error Recovery Utilities\n * Automatic error detection and recovery for common installation issues\n */\n\nimport { execSync } from 'child_process';\nimport * as fs from 'fs-extra';\nimport * as path from 'path';\nimport * as os from 'os';\n\n// =============================================================================\n// Test Mode Support\n// =============================================================================\n\n/**\n * Check if running in test mode\n */\nfunction isTestMode(): boolean {\n  return (\n    process.env.NODE_ENV === 'test' ||\n    process.env.TIARA_TEST_MODE === 'true' ||\n    process.env.TIARA_MOCK_NPM === 'true' ||\n    process.env.VITEST === 'true' ||\n    process.env.JEST_WORKER_ID !== undefined\n  );\n}\n\n/**\n * Mock execSync for test mode\n */\nfunction execSyncTestMode(command: string, options?: any): string | Buffer {\n  if (process.env.TIARA_DEBUG === 'true') {\n    console.log(`[TEST] Would execute: ${command}`);\n  }\n  // Return mock success for npm commands\n  if (command.includes('npm cache clean')) {\n    return 'npm cache cleaned';\n  }\n  if (command.includes('npm install')) {\n    return 'installed successfully';\n  }\n  if (command.includes('which')) {\n    return '/usr/bin/' + command.split(' ')[1];\n  }\n  if (command.includes('chmod')) {\n    return '';\n  }\n  return '';\n}\n\n/**\n * Safe execSync that respects test mode\n */\nfunction safeExecSync(command: string, options?: any): string | Buffer {\n  if (isTestMode()) {\n    return execSyncTestMode(command, options);\n  }\n  return execSync(command, options);\n}\n\nexport interface RecoveryResult {\n  success: boolean;\n  action: string;\n  message: string;\n  recovered: boolean;\n}\n\nexport interface RetryOptions {\n  maxRetries?: number;\n  delay?: number;\n  onRetry?: (attempt: number, error: Error) => void;\n  cleanupFn?: () => Promise<void>;\n}\n\n/**\n * Detect if an error is the ENOTEMPTY npm cache error\n */\nexport function isNpmCacheError(error: any): boolean {\n  const errorStr = error?.message || String(error);\n  return (\n    errorStr.includes('ENOTEMPTY') &&\n    (errorStr.includes('npm') || errorStr.includes('npx') || errorStr.includes('_npx'))\n  ) || errorStr.includes('better-sqlite3');\n}\n\n/**\n * Detect if an error is a native module version mismatch (NODE_MODULE_VERSION)\n * This happens when native modules are compiled for a different Node.js version\n */\nexport function isNativeModuleVersionError(error: any): boolean {\n  const errorStr = error?.message || String(error);\n  return (\n    errorStr.includes('NODE_MODULE_VERSION') ||\n    errorStr.includes('was compiled against a different Node.js version') ||\n    errorStr.includes('re-compiling or re-installing the module')\n  );\n}\n\n/**\n * Get helpful message for native module version mismatch\n */\nexport function getNativeModuleRecoveryMessage(error: any): string {\n  const errorStr = error?.message || String(error);\n\n  // Extract version numbers if available\n  const compiledMatch = errorStr.match(/NODE_MODULE_VERSION (\\d+)/);\n  const requiredMatch = errorStr.match(/requires\\s+NODE_MODULE_VERSION (\\d+)/);\n\n  let message = '‚ö†Ô∏è  Native module version mismatch detected.\\n';\n\n  if (compiledMatch && requiredMatch) {\n    const nodeVersionMap: Record<string, string> = {\n      '108': '18.x',\n      '115': '20.x',\n      '120': '21.x',\n      '127': '22.x',\n      '131': '23.x'\n    };\n    const compiled = nodeVersionMap[compiledMatch[1]] || `ABI ${compiledMatch[1]}`;\n    const required = nodeVersionMap[requiredMatch[1]] || `ABI ${requiredMatch[1]}`;\n    message += `   Module was compiled for Node.js ${compiled}, but running Node.js ${required}.\\n`;\n  }\n\n  message += '\\n   To fix this, try one of:\\n';\n  message += '   1. npm rebuild better-sqlite3\\n';\n  message += '   2. rm -rf node_modules && npm install\\n';\n  message += '   3. npx cache: rm -rf ~/.npm/_npx/ && run command again\\n';\n\n  return message;\n}\n\n/**\n * Detect if running on WSL (Windows Subsystem for Linux)\n */\nexport function isWSL(): boolean {\n  if (process.platform !== 'linux') {\n    return false;\n  }\n\n  try {\n    const release = fs.readFileSync('/proc/version', 'utf8').toLowerCase();\n    return release.includes('microsoft') || release.includes('wsl');\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Clean npm and npx cache directories\n */\nexport async function cleanNpmCache(): Promise<RecoveryResult> {\n  const homeDir = os.homedir();\n  const npxCacheDir = path.join(homeDir, '.npm', '_npx');\n\n  // In test mode, return mock success without actual operations\n  if (isTestMode()) {\n    if (process.env.TIARA_DEBUG === 'true') {\n      console.log('[TEST] Mock: npm cache cleaned');\n    }\n    return {\n      success: true,\n      action: 'cache-cleanup',\n      message: 'npm/npx cache cleaned successfully (test mode)',\n      recovered: true\n    };\n  }\n\n  try {\n    console.log('üßπ Cleaning npm cache...');\n\n    // Clean npm cache\n    try {\n      safeExecSync('npm cache clean --force', { stdio: 'pipe' });\n      console.log('‚úÖ npm cache cleaned');\n    } catch (error) {\n      console.warn('‚ö†Ô∏è  npm cache clean failed, continuing...');\n    }\n\n    // Remove npx cache directory\n    if (await fs.pathExists(npxCacheDir)) {\n      console.log(`üóëÔ∏è  Removing npx cache: ${npxCacheDir}`);\n      await fs.remove(npxCacheDir);\n      console.log('‚úÖ npx cache removed');\n    }\n\n    // Fix permissions on WSL\n    if (isWSL()) {\n      const npmDir = path.join(homeDir, '.npm');\n      if (await fs.pathExists(npmDir)) {\n        try {\n          safeExecSync(`chmod -R 755 \"${npmDir}\"`, { stdio: 'pipe' });\n          console.log('‚úÖ npm directory permissions fixed');\n        } catch (error) {\n          console.warn('‚ö†Ô∏è  Permission fix failed, continuing...');\n        }\n      }\n    }\n\n    return {\n      success: true,\n      action: 'cache-cleanup',\n      message: 'npm/npx cache cleaned successfully',\n      recovered: true\n    };\n  } catch (error) {\n    return {\n      success: false,\n      action: 'cache-cleanup',\n      message: `Failed to clean cache: ${error instanceof Error ? error.message : String(error)}`,\n      recovered: false\n    };\n  }\n}\n\n/**\n * Automatic retry with exponential backoff and error recovery\n */\nexport async function retryWithRecovery<T>(\n  fn: () => Promise<T>,\n  options: RetryOptions = {}\n): Promise<T> {\n  const {\n    maxRetries = 3,\n    delay = 1000,\n    onRetry,\n    cleanupFn\n  } = options;\n\n  let lastError: Error | undefined;\n\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (error) {\n      lastError = error as Error;\n\n      // Check if it's a recoverable error\n      if (isNpmCacheError(error)) {\n        console.log(`\\n‚ö†Ô∏è  Detected npm cache error (attempt ${attempt}/${maxRetries})`);\n\n        // Attempt automatic recovery\n        const recovery = await cleanNpmCache();\n        if (recovery.success) {\n          console.log('‚úÖ Cache cleaned, retrying...\\n');\n\n          // Run custom cleanup if provided\n          if (cleanupFn) {\n            await cleanupFn();\n          }\n\n          // Exponential backoff\n          const backoffDelay = delay * Math.pow(2, attempt - 1);\n          await new Promise(resolve => setTimeout(resolve, backoffDelay));\n\n          continue; // Retry\n        } else {\n          console.error('‚ùå Cache cleanup failed:', recovery.message);\n        }\n      }\n\n      // Call retry callback\n      if (onRetry && attempt < maxRetries) {\n        onRetry(attempt, lastError);\n        await new Promise(resolve => setTimeout(resolve, delay));\n        continue;\n      }\n\n      // Last attempt failed\n      if (attempt === maxRetries) {\n        break;\n      }\n    }\n  }\n\n  // All retries exhausted\n  throw new Error(\n    `Operation failed after ${maxRetries} attempts. ` +\n    `Last error: ${lastError?.message || 'Unknown error'}`\n  );\n}\n\n/**\n * WSL-specific error recovery\n */\nexport async function recoverWSLErrors(): Promise<RecoveryResult> {\n  if (!isWSL()) {\n    return {\n      success: true,\n      action: 'wsl-check',\n      message: 'Not running on WSL, no recovery needed',\n      recovered: false\n    };\n  }\n\n  console.log('üîç Detected WSL environment, applying fixes...');\n\n  try {\n    const homeDir = os.homedir();\n\n    // Check if running from Windows mount\n    const cwd = process.cwd();\n    if (cwd.startsWith('/mnt/')) {\n      console.warn('‚ö†Ô∏è  WARNING: Running from Windows filesystem (/mnt/)');\n      console.warn('   For best results, run from WSL filesystem (e.g., ~/projects/)');\n    }\n\n    // Ensure build tools are available\n    try {\n      execSync('which gcc', { stdio: 'pipe' });\n    } catch {\n      console.warn('‚ö†Ô∏è  build-essential not found. Install with:');\n      console.warn('   sudo apt-get update && sudo apt-get install -y build-essential python3');\n    }\n\n    // Clean cache with WSL-specific handling\n    return await cleanNpmCache();\n  } catch (error) {\n    return {\n      success: false,\n      action: 'wsl-recovery',\n      message: `WSL recovery failed: ${error instanceof Error ? error.message : String(error)}`,\n      recovered: false\n    };\n  }\n}\n\n/**\n * Verify better-sqlite3 installation\n */\nexport async function verifyBetterSqlite3(): Promise<boolean> {\n  // In test mode, return true (mock success)\n  if (isTestMode()) {\n    return true;\n  }\n  try {\n    require.resolve('better-sqlite3');\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Install better-sqlite3 with retry and error recovery\n */\nexport async function installBetterSqlite3WithRecovery(): Promise<RecoveryResult> {\n  // In test mode, return mock success without actual operations\n  if (isTestMode()) {\n    if (process.env.TIARA_DEBUG === 'true') {\n      console.log('[TEST] Mock: better-sqlite3 installed');\n    }\n    return {\n      success: true,\n      action: 'install-sqlite',\n      message: 'better-sqlite3 installed successfully (test mode)',\n      recovered: true\n    };\n  }\n\n  console.log('üì¶ Installing better-sqlite3...');\n\n  return retryWithRecovery(\n    async () => {\n      execSync('npm install better-sqlite3 --no-save', {\n        stdio: 'inherit',\n        cwd: process.cwd()\n      });\n\n      // Verify installation\n      if (await verifyBetterSqlite3()) {\n        return {\n          success: true,\n          action: 'install-sqlite',\n          message: 'better-sqlite3 installed successfully',\n          recovered: true\n        };\n      } else {\n        throw new Error('Installation completed but module not found');\n      }\n    },\n    {\n      maxRetries: 3,\n      delay: 2000,\n      onRetry: (attempt, error) => {\n        console.log(`‚ö†Ô∏è  Install attempt ${attempt} failed: ${error.message}`);\n        console.log('üîÑ Cleaning cache and retrying...');\n      }\n    }\n  );\n}\n\n/**\n * Comprehensive error recovery for initialization\n */\nexport async function recoverInitErrors(error: any): Promise<RecoveryResult> {\n  console.log('\\nüö® Error detected during initialization');\n  console.log(`   Error: ${error?.message || String(error)}\\n`);\n\n  // WSL-specific recovery\n  if (isWSL()) {\n    console.log('üîß Applying WSL-specific fixes...');\n    const wslRecovery = await recoverWSLErrors();\n    if (!wslRecovery.success) {\n      return wslRecovery;\n    }\n  }\n\n  // npm cache error recovery\n  if (isNpmCacheError(error)) {\n    console.log('üîß Detected npm cache error, attempting recovery...');\n    const cacheRecovery = await cleanNpmCache();\n    if (!cacheRecovery.success) {\n      return cacheRecovery;\n    }\n\n    // Try to reinstall better-sqlite3\n    if (!await verifyBetterSqlite3()) {\n      console.log('üîß better-sqlite3 missing, attempting reinstall...');\n      return await installBetterSqlite3WithRecovery();\n    }\n\n    return {\n      success: true,\n      action: 'error-recovery',\n      message: 'Cache cleaned and dependencies verified',\n      recovered: true\n    };\n  }\n\n  // Generic error handling\n  return {\n    success: false,\n    action: 'error-recovery',\n    message: `Unable to automatically recover from error: ${error?.message || String(error)}`,\n    recovered: false\n  };\n}\n\n/**\n * Export utility functions\n */\nexport const errorRecovery = {\n  isNpmCacheError,\n  isNativeModuleVersionError,\n  getNativeModuleRecoveryMessage,\n  isWSL,\n  cleanNpmCache,\n  retryWithRecovery,\n  recoverWSLErrors,\n  verifyBetterSqlite3,\n  installBetterSqlite3WithRecovery,\n  recoverInitErrors\n};\n"],"names":["execSync","fs","path","os","isTestMode","process","env","NODE_ENV","TIARA_TEST_MODE","TIARA_MOCK_NPM","VITEST","JEST_WORKER_ID","undefined","execSyncTestMode","command","options","TIARA_DEBUG","console","log","includes","split","safeExecSync","isNpmCacheError","error","errorStr","message","String","isNativeModuleVersionError","getNativeModuleRecoveryMessage","compiledMatch","match","requiredMatch","nodeVersionMap","compiled","required","isWSL","platform","release","readFileSync","toLowerCase","cleanNpmCache","homeDir","homedir","npxCacheDir","join","success","action","recovered","stdio","warn","pathExists","remove","npmDir","Error","retryWithRecovery","fn","maxRetries","delay","onRetry","cleanupFn","lastError","attempt","recovery","backoffDelay","Math","pow","Promise","resolve","setTimeout","recoverWSLErrors","cwd","startsWith","verifyBetterSqlite3","require","installBetterSqlite3WithRecovery","recoverInitErrors","wslRecovery","cacheRecovery","errorRecovery"],"mappings":"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"}