{"version":3,"sources":["../../../../src/cli/commands/claude.ts"],"sourcesContent":["/**\n * Claude instance management commands\n *\n * Uses agent-core daemon API for execution instead of spawning Claude CLI directly.\n */\nimport { promises as fs } from 'node:fs';\n\nimport { Command } from '../commander-fix.js';\nimport chalk from 'chalk';\nimport { generateId } from '../../utils/helpers.js';\nimport {\n  getAgentCoreClient,\n  type PersonaId,\n  type PromptCallbacks,\n} from '../../agent-core/index.js';\n\nexport const claudeCommand = new Command()\n  .name('claude')\n  .description('Manage Claude instances')\n  .action(() => {\n    claudeCommand.help();\n  });\n\n// Spawn command\nclaudeCommand\n  .command('spawn')\n  .description('Spawn a new Claude instance with specific configuration')\n  .arguments('<task>')\n  .option(\n    '-t, --tools <tools>',\n    'Allowed tools (comma-separated)',\n    'View,Edit,Replace,GlobTool,GrepTool,LS,Bash',\n  )\n  .option('--no-permissions', 'Use --dangerously-skip-permissions flag')\n  .option('-c, --config <config>', 'MCP config file path')\n  .option(\n    '-m, --mode <mode>',\n    'Development mode (full, backend-only, frontend-only, api-only)',\n    'full',\n  )\n  .option('--parallel', 'Enable parallel execution with BatchTool')\n  .option('--research', 'Enable web research with WebFetchTool')\n  .option('--coverage <coverage>', 'Test coverage target', '80')\n  .option('--commit <frequency>', 'Commit frequency (phase, feature, manual)', 'phase')\n  .option('-v, --verbose', 'Enable verbose output')\n  .option('--dry-run', 'Show what would be executed without running')\n  .action(async (task: string, options: any) => {\n    try {\n      const instanceId = generateId('claude');\n\n      // Build tools list (for display only, daemon handles tool access)\n      let tools = options.tools;\n      if (options.parallel && !tools.includes('BatchTool')) {\n        tools += ',BatchTool,dispatch_agent';\n      }\n      if (options.research && !tools.includes('WebFetchTool')) {\n        tools += ',WebFetchTool';\n      }\n\n      if (options.dryRun) {\n        console.log(chalk.yellow('DRY RUN - Would execute via daemon:'));\n        console.log('\\nConfiguration:');\n        console.log(`  Instance ID: ${instanceId}`);\n        console.log(`  Task: ${task}`);\n        console.log(`  Tools: ${tools}`);\n        console.log(`  Mode: ${options.mode}`);\n        console.log(`  Coverage: ${parseInt(options.coverage)}%`);\n        console.log(`  Commit: ${options.commit}`);\n        console.log(`  Persona: zee (default)`);\n        return;\n      }\n\n      console.log(chalk.green(`Spawning Claude instance: ${instanceId}`));\n      console.log(chalk.gray(`Task: ${task}`));\n      console.log(chalk.gray(`Tools: ${tools}`));\n      console.log(chalk.gray(`Routing to persona: zee`));\n\n      // Execute via agent-core daemon API\n      const client = getAgentCoreClient();\n      await client.ensureConnected();\n\n      const session = await client.createSession({\n        title: instanceId,\n      });\n\n      const callbacks: PromptCallbacks = {\n        onText: (text) => process.stdout.write(text),\n        onReasoning: (text) => {\n          if (options.verbose) {\n            console.log(chalk.dim(`[reasoning] ${text}`));\n          }\n        },\n        onToolStart: (tool) => {\n          if (options.verbose) {\n            console.log(chalk.cyan(`[tool] ${tool}...`));\n          }\n        },\n        onToolEnd: (tool, _result) => {\n          if (options.verbose) {\n            console.log(chalk.green(`[tool] ${tool} completed`));\n          }\n        },\n        onError: (err) => {\n          console.error(chalk.red(`Error: ${err.message}`));\n        },\n      };\n\n      const result = await client.prompt(\n        {\n          sessionId: session.id,\n          prompt: task,\n          persona: 'zee' as PersonaId,\n        },\n        callbacks\n      );\n\n      // Cleanup session\n      try {\n        await client.deleteSession(session.id);\n      } catch {\n        // Ignore cleanup errors\n      }\n\n      if (result.success) {\n        console.log(); // Newline after streamed output\n        console.log(chalk.green(`Claude instance ${instanceId} completed successfully`));\n      } else {\n        console.log(chalk.red(`Claude instance ${instanceId} failed: ${result.error ?? 'Unknown error'}`));\n      }\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      if (message.includes('daemon not running')) {\n        console.error(chalk.red('agent-core daemon not running. Start it with:'));\n        console.log(chalk.yellow('  agent-core daemon --external-gateway'));\n      } else {\n        console.error(chalk.red('Failed to spawn Claude:'), message);\n      }\n    }\n  });\n\n// Batch command\nclaudeCommand\n  .command('batch')\n  .description('Spawn multiple Claude instances from workflow')\n  .arguments('<workflow-file>')\n  .option('--dry-run', 'Show what would be executed without running')\n  .action(async (workflowFile: string, options: any) => {\n    try {\n      const content = await fs.readFile(workflowFile, 'utf-8');\n      const workflow = JSON.parse(content);\n\n      console.log(chalk.green('Loading workflow:'), workflow.name || 'Unnamed');\n      console.log(chalk.gray(`Tasks: ${workflow.tasks?.length || 0}`));\n\n      if (!workflow.tasks || workflow.tasks.length === 0) {\n        console.log(chalk.yellow('No tasks found in workflow'));\n        return;\n      }\n\n      // Get client and ensure daemon is running\n      const client = getAgentCoreClient();\n      await client.ensureConnected();\n\n      for (const task of workflow.tasks) {\n        const taskPrompt = task.description || task.name;\n        const taskId = task.id || generateId('task');\n\n        if (options.dryRun) {\n          console.log(chalk.yellow(`\\nDRY RUN - Task: ${task.name || task.id}`));\n          console.log(chalk.gray(`  Prompt: ${taskPrompt}`));\n          console.log(chalk.gray(`  Persona: ${task.persona || 'zee'}`));\n        } else {\n          console.log(chalk.blue(`\\nExecuting task: ${task.name || task.id}`));\n\n          const session = await client.createSession({\n            title: `batch-${taskId}`,\n          });\n\n          const callbacks: PromptCallbacks = {\n            onText: (text) => process.stdout.write(text),\n            onError: (err) => console.error(chalk.red(`Error: ${err.message}`)),\n          };\n\n          const result = await client.prompt(\n            {\n              sessionId: session.id,\n              prompt: taskPrompt,\n              persona: (task.persona || 'zee') as PersonaId,\n            },\n            callbacks\n          );\n\n          // Cleanup session\n          try {\n            await client.deleteSession(session.id);\n          } catch {\n            // Ignore cleanup errors\n          }\n\n          if (result.success) {\n            console.log(chalk.green(`\\nTask ${taskId} completed successfully`));\n          } else {\n            console.log(chalk.red(`\\nTask ${taskId} failed: ${result.error ?? 'Unknown error'}`));\n          }\n\n          // Sequential execution (default) - already sequential via await\n        }\n      }\n\n      if (!options.dryRun) {\n        console.log(chalk.green('\\nWorkflow completed'));\n      }\n    } catch (error) {\n      const message = error instanceof Error ? error.message : String(error);\n      if (message.includes('daemon not running')) {\n        console.error(chalk.red('agent-core daemon not running. Start it with:'));\n        console.log(chalk.yellow('  agent-core daemon --external-gateway'));\n      } else {\n        console.error(chalk.red('Failed to process workflow:'), message);\n      }\n    }\n  });\n"],"names":["promises","fs","Command","chalk","generateId","getAgentCoreClient","claudeCommand","name","description","action","help","command","arguments","option","task","options","instanceId","tools","parallel","includes","research","dryRun","console","log","yellow","mode","parseInt","coverage","commit","green","gray","client","ensureConnected","session","createSession","title","callbacks","onText","text","process","stdout","write","onReasoning","verbose","dim","onToolStart","tool","cyan","onToolEnd","_result","onError","err","error","red","message","result","prompt","sessionId","id","persona","deleteSession","success","Error","String","workflowFile","content","readFile","workflow","JSON","parse","tasks","length","taskPrompt","taskId","blue"],"mappings":"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"}