{"version":3,"sources":["../../../../src/cli/commands/hook.ts"],"sourcesContent":["import { spawn } from 'child_process';\nimport { Logger } from '../../core/logger.js';\nimport type {\n  PreTaskOptions,\n  PostTaskOptions,\n  PreEditOptions,\n  PostEditOptions,\n  PreCommandOptions,\n  PostCommandOptions,\n  SessionStartOptions,\n  SessionEndOptions,\n  SessionRestoreOptions,\n  PreSearchOptions,\n  NotificationOptions,\n  HookCommandOptions,\n  PerformanceOptions,\n  MemorySyncOptions,\n  TelemetryOptions,\n  TodoContinuationOptions,\n} from './hook-types.js';\n\nconst logger = new Logger(\n  {\n    level: 'info',\n    format: 'text',\n    destination: 'console',\n  },\n  { prefix: 'Hook' },\n);\n\n// Helper function to build command arguments\nfunction buildArgs(hookType: string, options: Record<string, any>): string[] {\n  const args = [hookType];\n\n  Object.entries(options).forEach(([key, value]) => {\n    if (value !== undefined && value !== null) {\n      const flagName = key.replace(/([A-Z])/g, '-$1').toLowerCase();\n\n      if (typeof value === 'boolean') {\n        if (value) {\n          args.push(`--${flagName}`);\n        } else {\n          args.push(`--no-${flagName}`);\n        }\n      } else {\n        args.push(`--${flagName}`, String(value));\n      }\n    }\n  });\n\n  return args;\n}\n\n// Hook subcommand handlers\nconst hookHandlers: Record<string, (args: string[]) => Promise<void>> = {\n  'pre-task': async (args: string[]) => {\n    const options = parseArgs<PreTaskOptions>(args);\n    await executeHook('pre-task', options);\n  },\n\n  'post-task': async (args: string[]) => {\n    const options = parseArgs<PostTaskOptions>(args);\n    if (!options.taskId) {\n      throw new Error('--task-id is required for post-task hook');\n    }\n    await executeHook('post-task', options);\n  },\n\n  'pre-edit': async (args: string[]) => {\n    const options = parseArgs<PreEditOptions>(args);\n    if (!options.file) {\n      throw new Error('--file is required for pre-edit hook');\n    }\n    await executeHook('pre-edit', options);\n  },\n\n  'post-edit': async (args: string[]) => {\n    const options = parseArgs<PostEditOptions>(args);\n    if (!options.file) {\n      throw new Error('--file is required for post-edit hook');\n    }\n    await executeHook('post-edit', options);\n  },\n\n  'pre-command': async (args: string[]) => {\n    const options = parseArgs<PreCommandOptions>(args);\n    if (!options.command) {\n      throw new Error('--command is required for pre-command hook');\n    }\n    await executeHook('pre-command', options);\n  },\n\n  'post-command': async (args: string[]) => {\n    const options = parseArgs<PostCommandOptions>(args);\n    if (!options.command) {\n      throw new Error('--command is required for post-command hook');\n    }\n    await executeHook('post-command', options);\n  },\n\n  'session-start': async (args: string[]) => {\n    const options = parseArgs<SessionStartOptions>(args);\n    await executeHook('session-start', options);\n  },\n\n  'session-end': async (args: string[]) => {\n    const options = parseArgs<SessionEndOptions>(args);\n\n    // If persisting state, save current todos to memory for restoration\n    if (options.persistState !== false && options.sessionId) {\n      try {\n        const { createHookContext } = await import(\n          '../../services/agentic-flow-hooks/index.js'\n        );\n\n        const context = createHookContext()\n          .withSession(options.sessionId)\n          .withMetadata({ sessionEnd: true })\n          .build();\n\n        // Store todos in session memory if provided via metadata\n        if (options.metadata?.todos) {\n          const todosKey = `session/${options.sessionId}/todos`;\n          context.memory.cache.set(todosKey, options.metadata.todos);\n          logger.debug('Saved todos to session memory', {\n            sessionId: options.sessionId,\n            todoCount: options.metadata.todos.length,\n          });\n        }\n      } catch (err) {\n        logger.debug('Failed to save todos to session memory:', err);\n      }\n    }\n\n    await executeHook('session-end', options);\n  },\n\n  'session-restore': async (args: string[]) => {\n    const options = parseArgs<SessionRestoreOptions>(args);\n    if (!options.sessionId) {\n      throw new Error('--session-id is required for session-restore hook');\n    }\n    await executeHook('session-restore', options);\n\n    // If loading tasks and not skipping continuation, trigger todo-continuation check\n    if (options.loadTasks !== false && !options.skipTodoContinuation) {\n      try {\n        const {\n          createTodoContinuationPayload,\n          shouldTriggerContinuation,\n        } = await import('../../services/agentic-flow-hooks/todo-continuation-hooks.js');\n        const { createHookContext, agenticHookManager } = await import(\n          '../../services/agentic-flow-hooks/index.js'\n        );\n\n        // Try to load todos from options or session memory\n        const context = createHookContext()\n          .withSession(options.sessionId)\n          .withMetadata({ sessionRestore: true })\n          .build();\n\n        // Use provided todos or load from memory\n        let storedTodos = options.todos || [];\n        if (storedTodos.length === 0) {\n          // Check for todos in memory (key pattern: session/<id>/todos)\n          const todosKey = `session/${options.sessionId}/todos`;\n          storedTodos = context.memory.cache.get(todosKey) || [];\n        }\n\n        // Create payload and check if continuation is needed\n        const payload = createTodoContinuationPayload(storedTodos, {\n          proceedWithoutAsking: true,\n          completionThreshold: 100,\n        });\n\n        if (shouldTriggerContinuation(payload.todoState)) {\n          // Add todoState to context\n          context.todoState = payload.todoState;\n\n          // Execute todo-continuation hook\n          await agenticHookManager.executeHooks('todo-continuation', payload, context);\n\n          // Output the reminder\n          console.log('\\n[SYSTEM REMINDER - TODO CONTINUATION]\\n');\n          console.log('Incomplete tasks remain in your todo list. Continue working on the next pending task.\\n');\n          console.log('- Proceed without asking for permission');\n          console.log('- Mark each task complete when finished');\n          console.log('- Do not stop until all tasks are done\\n');\n          console.log(\n            `[Status: ${payload.todoState.completed}/${payload.todoState.total} completed, ${payload.todoState.remaining} remaining]\\n`\n          );\n\n          logger.info('Session restored with todo continuation', {\n            sessionId: options.sessionId,\n            todoState: payload.todoState,\n          });\n        } else {\n          logger.debug('Session restored, no incomplete tasks');\n        }\n      } catch (err) {\n        // Don't fail session restore if todo-continuation fails\n        logger.debug('Todo continuation check skipped:', err);\n      }\n    }\n  },\n\n  'pre-search': async (args: string[]) => {\n    const options = parseArgs<PreSearchOptions>(args);\n    if (!options.query) {\n      throw new Error('--query is required for pre-search hook');\n    }\n    await executeHook('pre-search', options);\n  },\n\n  notification: async (args: string[]) => {\n    const options = parseArgs<NotificationOptions>(args);\n    if (!options.message) {\n      throw new Error('--message is required for notification hook');\n    }\n    await executeHook('notification', options);\n  },\n\n  performance: async (args: string[]) => {\n    const options = parseArgs<PerformanceOptions>(args);\n    await executeHook('performance', options);\n  },\n\n  'memory-sync': async (args: string[]) => {\n    const options = parseArgs<MemorySyncOptions>(args);\n    await executeHook('memory-sync', options);\n  },\n\n  telemetry: async (args: string[]) => {\n    const options = parseArgs<TelemetryOptions>(args);\n    if (!options.event) {\n      throw new Error('--event is required for telemetry hook');\n    }\n    await executeHook('telemetry', options);\n  },\n\n  'todo-continuation': async (args: string[]) => {\n    const options = parseArgs<TodoContinuationOptions>(args);\n    // Use local hook implementation\n    const {\n      createTodoContinuationPayload,\n      calculateTodoState,\n    } = await import('../../services/agentic-flow-hooks/todo-continuation-hooks.js');\n    const { createHookContext, agenticHookManager } = await import(\n      '../../services/agentic-flow-hooks/index.js'\n    );\n\n    // Parse todos from options or create empty state\n    const todos = options.todos || [];\n    const payload = createTodoContinuationPayload(todos, {\n      proceedWithoutAsking: options.proceedWithoutAsking ?? true,\n      completionThreshold: options.checkCompletionThreshold ?? 100,\n    });\n\n    // Build context\n    const context = createHookContext()\n      .withSession(`cli-${Date.now()}`)\n      .withMetadata({ cliInvoked: true, statusFormat: options.statusFormat })\n      .build();\n\n    // Add todoState to context\n    context.todoState = payload.todoState;\n\n    // Execute the hook\n    const results = await agenticHookManager.executeHooks('todo-continuation', payload, context);\n\n    // Output the result\n    console.log('\\n[SYSTEM REMINDER - TODO CONTINUATION]\\n');\n    if (payload.todoState.remaining === 0) {\n      console.log('All tasks completed. No continuation needed.\\n');\n    } else {\n      console.log('Incomplete tasks remain in your todo list. Continue working on the next pending task.\\n');\n      if (options.proceedWithoutAsking) {\n        console.log('- Proceed without asking for permission');\n      }\n      console.log('- Mark each task complete when finished');\n      console.log('- Do not stop until all tasks are done\\n');\n      console.log(\n        `[Status: ${payload.todoState.completed}/${payload.todoState.total} completed, ${payload.todoState.remaining} remaining]\\n`\n      );\n    }\n\n    logger.info('Todo continuation hook executed', {\n      todoState: payload.todoState,\n      results: results.length,\n    });\n  },\n};\n\n// Parse command line arguments\nfunction parseArgs<T extends Record<string, any>>(args: string[]): T {\n  const options: Record<string, any> = {};\n\n  for (let i = 0; i < args.length; i++) {\n    const arg = args[i];\n\n    if (arg.startsWith('--')) {\n      const key = arg.slice(2).replace(/-([a-z])/g, (_, letter) => letter.toUpperCase());\n      const nextArg = args[i + 1];\n\n      if (!nextArg || nextArg.startsWith('--')) {\n        // Boolean flag\n        options[key] = !arg.startsWith('--no-');\n      } else {\n        // Value flag\n        options[key] = nextArg;\n        i++; // Skip next arg\n      }\n    }\n  }\n\n  return options as T;\n}\n\n// Execute hook with ruv-swarm\nasync function executeHook(hookType: string, options: Record<string, any>): Promise<void> {\n  const args = buildArgs(hookType, options);\n\n  logger.debug(`Executing hook: ruv-swarm hook ${args.join(' ')}`);\n\n  const child = spawn('npx', ['ruv-swarm', 'hook', ...args], {\n    stdio: 'inherit',\n    shell: true,\n  });\n\n  await new Promise<void>((resolve, reject) => {\n    child.on('exit', (code) => {\n      if (code === 0) {\n        resolve();\n      } else {\n        reject(new Error(`Hook ${hookType} failed with exit code ${code}`));\n      }\n    });\n\n    child.on('error', (error) => {\n      logger.error(`Failed to execute hook ${hookType}:`, error);\n      reject(error);\n    });\n  });\n}\n\n// Main hook command handler\nexport const hookCommand = {\n  name: 'hook',\n  description: 'Execute ruv-swarm hooks for agent coordination',\n  action: async ({ args }: HookCommandOptions): Promise<void> => {\n    try {\n      if (args.length === 0) {\n        showHookHelp();\n        return;\n      }\n\n      const subcommand = args[0];\n      const handler = hookHandlers[subcommand];\n\n      if (!handler) {\n        logger.error(`Unknown hook subcommand: ${subcommand}`);\n        showHookHelp();\n        throw new Error(`Unknown hook subcommand: ${subcommand}`);\n      }\n\n      await handler(args.slice(1));\n    } catch (error) {\n      logger.error('Hook command error:', error);\n      throw error;\n    }\n  },\n};\n\n// Show help for hook commands\nfunction showHookHelp(): void {\n  console.log(`\nClaude Flow Hook Commands\n========================\n\nAvailable hooks:\n\n  pre-task      - Run before starting a task\n    --description <desc>      Task description\n    --auto-spawn-agents       Auto-spawn agents (default: true)\n    --complexity <level>      Task complexity: low|medium|high\n    --estimated-minutes <n>   Estimated duration\n    --requires-research       Task requires research\n    --requires-testing        Task requires testing\n\n  post-task     - Run after completing a task\n    --task-id <id>           Task ID (required)\n    --analyze-performance    Analyze performance metrics\n    --generate-report        Generate completion report\n\n  pre-edit      - Run before editing a file\n    --file <path>            File path (required)\n    --operation <op>         Operation type: read|write|edit|delete\n    --validate               Validate file before edit\n\n  post-edit     - Run after editing a file\n    --file <path>            File path (required)\n    --memory-key <key>       Store in memory with key\n    --format                 Auto-format code\n    --analyze                Analyze changes\n\n  pre-command   - Run before executing a command\n    --command <cmd>          Command to execute (required)\n    --validate               Validate command safety\n    --sandbox                Run in sandbox mode\n\n  post-command  - Run after executing a command\n    --command <cmd>          Command executed (required)\n    --exit-code <code>       Command exit code\n    --duration <ms>          Execution duration\n\n  session-start - Run at session start\n    --session-id <id>        Session identifier\n    --load-previous          Load previous session data\n    --auto-restore           Auto-restore context\n\n  session-end   - Run at session end\n    --session-id <id>        Session identifier\n    --export-metrics         Export performance metrics\n    --generate-summary       Generate session summary\n    --save-to <path>         Save session data to path\n\n  session-restore - Restore a previous session\n    --session-id <id>        Session ID to restore (required)\n    --load-memory            Load memory state\n    --load-agents            Load agent configuration\n    --load-tasks             Load task list (triggers todo-continuation)\n    --skip-todo-continuation Skip automatic todo continuation check\n    --todos <json>           Todos to restore as JSON array\n\n  pre-search    - Run before searching\n    --query <text>           Search query (required)\n    --cache-results          Cache search results\n    --max-results <n>        Maximum results to return\n\n  notification  - Send a notification\n    --message <text>         Notification message (required)\n    --level <level>          Message level: info|warning|error\n    --telemetry              Include in telemetry\n    --persist                Persist notification\n\n  performance   - Track performance metrics\n    --operation <name>       Operation name\n    --duration <ms>          Operation duration\n    --metrics <json>         Performance metrics as JSON\n\n  memory-sync   - Synchronize memory state\n    --namespace <name>       Memory namespace\n    --direction <dir>        Sync direction: push|pull|sync\n    --target <location>      Target location for sync\n\n  telemetry     - Send telemetry data\n    --event <name>           Event name (required)\n    --data <json>            Event data as JSON\n    --tags <list>            Comma-separated tags\n\n  todo-continuation - Continue incomplete tasks automatically\n    --check-completion-threshold <n>  Minimum % before continuing (default: 0)\n    --auto-inject-reminder            Auto-inject reminder message\n    --proceed-without-asking          Continue without asking permission\n    --status-format <format>          Format: summary|detailed|brief\n    --todos <json>                    Current todos as JSON array\n\nCommon options:\n  --verbose                  Show detailed output\n  --metadata <json>          Additional metadata as JSON\n\nExamples:\n  claude hook pre-task --description \"Build REST API\" --complexity high\n  claude hook post-edit --file src/index.js --memory-key \"api/implementation\"\n  claude hook session-end --export-metrics --generate-summary\n  claude hook performance --operation \"api-build\" --duration 1234\n  claude hook memory-sync --namespace \"project\" --direction push\n  claude hook telemetry --event \"task-completed\" --data '{\"taskId\":\"123\"}'\n  claude hook todo-continuation --proceed-without-asking --status-format summary\n`);\n}\n\n// Export hook subcommands for better CLI integration\nexport const hookSubcommands = [\n  'pre-task',\n  'post-task',\n  'pre-edit',\n  'post-edit',\n  'pre-command',\n  'post-command',\n  'session-start',\n  'session-end',\n  'session-restore',\n  'pre-search',\n  'notification',\n  'performance',\n  'memory-sync',\n  'telemetry',\n  'todo-continuation',\n];\n"],"names":["spawn","Logger","logger","level","format","destination","prefix","buildArgs","hookType","options","args","Object","entries","forEach","key","value","undefined","flagName","replace","toLowerCase","push","String","hookHandlers","parseArgs","executeHook","taskId","Error","file","command","persistState","sessionId","createHookContext","context","withSession","withMetadata","sessionEnd","build","metadata","todos","todosKey","memory","cache","set","debug","todoCount","length","err","loadTasks","skipTodoContinuation","createTodoContinuationPayload","shouldTriggerContinuation","agenticHookManager","sessionRestore","storedTodos","get","payload","proceedWithoutAsking","completionThreshold","todoState","executeHooks","console","log","completed","total","remaining","info","query","notification","message","performance","telemetry","event","calculateTodoState","checkCompletionThreshold","Date","now","cliInvoked","statusFormat","results","i","arg","startsWith","slice","_","letter","toUpperCase","nextArg","join","child","stdio","shell","Promise","resolve","reject","on","code","error","hookCommand","name","description","action","showHookHelp","subcommand","handler","hookSubcommands"],"mappings":"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"}